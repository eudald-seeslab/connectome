---
title: "cleaning"
output: html_document
date: "2024-05-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(dplyr)
library(tidyr)
library(readr)
library(glue)
library(stringr)
```

```{r}
connections <- read_csv(
  "adult_data/connections.csv", col_types = "cccic"
  ) |> 
  group_by(pre_root_id, post_root_id) |> 
  summarise(syn_count = sum(syn_count))

cla <- read_csv("adult_data/classification.csv", 
                col_select = c(root_id, cell_type, side),
                col_types = "ccc"
                ) |> 
  filter(side == "right") |> 
  select(-side) 
```

```{r}
clean_conns <- connections |> 
  inner_join(cla, by = c("pre_root_id" = "root_id")) |> 
  inner_join(cla, by = c("post_root_id" = "root_id")) |> 
  ungroup()

clean_cla <- cla |> 
  inner_join(clean_conns |> distinct(pre_root_id), 
             by=c("root_id" = "pre_root_id"))
```

```{r}
coords <- read_csv(
  "adult_data/coordinates.csv",
  col_select = c(root_id, position),
  col_types = "cc"
) |>
  mutate(
    position = gsub("[", "", position, fixed = T),
    position = gsub("]", "", position, fixed = T),
    position = str_trim(position),
    position = str_squish(position)
  ) |>
  separate_wider_delim(position, " ", names = c("x", "y", "z")) |>
  mutate(across(c(x, y, z), as.numeric)) |> 
  group_by(root_id) |> 
  summarise(x = mean(x), y = mean(y), z = mean(z))
```

```{r}
cla_coords <- clean_cla |> 
  inner_join(coords)
```


```{r}
vis_coords <- cla_coords |> 
  filter(cell_type %in% c("R1-6", "R7", "R8")) |> 
  filter(
    y >= 225000 & y < 327400,
    z >= 75000 & z < 177400
  ) |> 
  mutate(
    y = (y - 225000) / 102400 * 512,
    z = (z - 75000) / 102400 * 512
  )
```

```{r}
clean_conns |> write_csv("adult_data/right_connections.csv")
clean_cla |> write_csv("adult_data/right_classification.csv")
vis_coords |> write_csv("adult_data/right_visual_neurons_positions.csv")
```


```{r}
vis_coords |> 
  inner_join(clean_conns |> distinct(pre_root_id), by=c("root_id" = "pre_root_id")) |> nrow()
```

